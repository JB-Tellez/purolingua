---
phase: 07-filter-logic
plan: 04
type: tdd
wave: 3
depends_on: [07-03]
files_modified:
  - tests/filter-logic.test.js
autonomous: true
requirements: [FLTR-07, FLTR-08]

must_haves:
  truths:
    - "getDueCount(deck, ['A1']) returns the exact same count as the number of A1 indices startDeck would push (count parity — FLTR-07)"
    - "getDueCount(deck, ['A2']) counts only A2 cards that are SRS-due — no A1 cards counted"
    - "generateChoices(correctCard, a1Cards) returns only A1-level foils — no A2 cards in choices (FLTR-08)"
    - "generateChoices(correctCard, a2Cards) returns only A2-level foils — no A1 cards in choices"
    - "All filter-logic tests pass (bun run test exits 0)"
  artifacts:
    - path: "tests/filter-logic.test.js"
      provides: "Extended test suite with count-parity and foil-contamination tests"
      min_lines: 100
  key_links:
    - from: "tests/filter-logic.test.js"
      to: "src/js/features/progress.js"
      via: "getDueCount(deck, activeLevels) imported and called with level-filtered expectations"
      pattern: "getDueCount.*A1"
    - from: "tests/filter-logic.test.js"
      to: "src/js/utils/deck-utils.js"
      via: "generateChoices(correctCard, filteredCards) imported and called with level-restricted card arrays"
      pattern: "generateChoices.*filteredCards|a1Cards|a2Cards"
---

<objective>
Extend tests/filter-logic.test.js with count-parity tests (FLTR-07) and foil-contamination tests (FLTR-08). These are the two most critical behavioral guarantees of Phase 7 — they verify that the badge and session always agree, and that quiz foils never cross level boundaries.

Purpose: Catch any divergence between getDueCount and startDeck logic, and verify generateChoices is truly using the pre-filtered pool. These tests are the regression net for all future deck or logic changes.
Output: tests/filter-logic.test.js extended to cover FLTR-07 and FLTR-08.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/07-filter-logic/07-RESEARCH.md
@.planning/phases/07-filter-logic/07-03-SUMMARY.md
@src/js/features/progress.js
@src/js/utils/deck-utils.js
@tests/filter-logic.test.js
@tests/vitest.setup.js
</context>

<feature>
  <name>Count Parity and Foil Filtering</name>
  <files>tests/filter-logic.test.js</files>
  <behavior>
These tests are ADDITIONS to the existing filter-logic.test.js created in Plan 02. Append two new describe blocks.

**Setup: mock deck fixture for level-filter tests.** Define a `mockLevelDeck` constant at the top of the new describe blocks:

```js
const mockLevelDeck = {
    id: 'test-level-deck',
    cards: [
        { front: 'ciao', back: 'hello', level: 'A2' },         // index 0
        { front: 'buongiorno', back: 'good morning', level: 'A2' }, // index 1
        { front: 'arrivederci', back: 'goodbye', level: 'A2' },   // index 2
        { front: 'prego', back: 'you are welcome', level: 'A2' },  // index 3
        { front: 'scusa', back: 'excuse me', level: 'A1' },       // index 4
        { front: 'per favore', back: 'please', level: 'A1' },     // index 5
        { front: 'grazie', back: 'thank you', level: 'A1' },      // index 6
        { front: 'di niente', back: 'not at all', level: 'A1' },  // index 7
    ]
};
```

**describe('getDueCount level filtering — FLTR-07'):**

All cards are new (no localStorage progress), so isCardDue returns true for all.

- `getDueCount(mockLevelDeck, ['A1'])` returns `4` (indices 4-7 are A1)
- `getDueCount(mockLevelDeck, ['A2'])` returns `4` (indices 0-3 are A2)
- `getDueCount(mockLevelDeck, ['A1', 'A2'])` returns `8` (all cards)
- Count parity test: the number returned by `getDueCount(mockLevelDeck, ['A1'])` equals the number of A1 cards whose `isCardDue` would return true. To test this without importing isCardDue directly, compute the expected count manually: filter mockLevelDeck.cards by level 'A1' (4 cards), all new (all due), expect getDueCount to return 4. This verifies the predicate parity.

Note: `getDueCount` calls `isCardDue` internally which reads from `progress`. Since localStorage is cleared in `beforeEach` (vitest.setup.js), all cards will be "new" (isCardDue returns true for cards with no progress entry). This setup gives deterministic counts.

Import `getDueCount` from `../src/js/features/progress.js`. Also import `loadProgress` and call it before getDueCount tests (getDueCount calls isCardDue which checks the module-level `progress` variable — `loadProgress()` must be called first to initialize it from the empty localStorage).

**describe('generateChoices foil filtering — FLTR-08'):**

- With A1 cards only: `generateChoices(a1Card, a1Cards)` returns 4 choices, all foil cards have `level: 'A1'` (verify by finding foil text in a1Cards)
- With A2 cards only: `generateChoices(a2Card, a2Cards)` returns 4 choices, all foil cards have `level: 'A2'`
- No cross-level contamination: `generateChoices(a1Card, a1Cards)` returns choices where every non-correct choice's text exists in a1Cards (not in a2Cards)

Setup:
```js
const a1Cards = mockLevelDeck.cards.filter(c => c.level === 'A1');
const a2Cards = mockLevelDeck.cards.filter(c => c.level === 'A2');
const a1Card = a1Cards[0]; // { front: 'scusa', back: 'excuse me', level: 'A1' }
const a2Card = a2Cards[0]; // { front: 'ciao', back: 'hello', level: 'A2' }
```

Import `generateChoices` from `../src/js/utils/deck-utils.js`.

The function signature is now `generateChoices(correctCard, filteredCards)` — pass `a1Cards` or `a2Cards` as the second argument (not the full deck object).
  </behavior>
  <implementation>
RED: Append the two new describe blocks to the existing tests/filter-logic.test.js. Run `bun run test tests/filter-logic.test.js`. Existing tests from Plan 02 should pass. New tests should also pass if Plan 03 was implemented correctly (getDueCount and generateChoices signatures updated).

If any new test fails, it indicates a bug in Plan 03's implementation — diagnose and fix the source file (not the test). The test is the spec.

GREEN: All tests pass after Plan 03 work is complete.

REFACTOR: Check test clarity. The count-parity describe block comment should make clear that "getDueCount returns the same count as the number of indices startDeck would push" — add a comment in the test if not obvious.
  </implementation>
</feature>

<verification>
Run: `bun run test`
Full test suite passes. Zero failures. Count includes original Plan 02 tests plus new FLTR-07/08 tests.

Expected passing test count in filter-logic.test.js: at least 18 tests total (10+ from Plan 02, 8+ new in Plan 04).
</verification>

<success_criteria>
- getDueCount level-filtered counts verified: ['A1'] → 4, ['A2'] → 4, ['A1','A2'] → 8 on mockLevelDeck
- generateChoices foil pool verified: A1-only input produces A1-only foils; A2-only input produces A2-only foils
- Full test suite (bun run test) exits 0
- filter-logic.test.js covers all 7 Phase 7 requirements (FLTR-02 through FLTR-08)
</success_criteria>

<output>
After completion, create `.planning/phases/07-filter-logic/07-04-SUMMARY.md` following the summary template.
</output>
