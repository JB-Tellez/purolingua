---
phase: 08-filter-ui
plan: 02
type: execute
wave: 2
depends_on:
  - 08-01
files_modified:
  - index.html
  - src/css/style.css
  - src/locales/it/ui.js
  - src/locales/es/ui.js
  - src/js/core/app.js
autonomous: false
requirements:
  - FLTR-01
  - FLTR-09

must_haves:
  truths:
    - "A1 and A2 chip buttons are visible above the deck grid on the deck selection screen"
    - "Clicking a chip toggles the active level and immediately updates deck badge counts"
    - "Chip labels update when the user switches app language (i18n driven)"
    - "All 7 tests in filter-ui.test.js pass after implementation (GREEN)"
    - "Existing test suite remains green — no regressions"
  artifacts:
    - path: "index.html"
      provides: "#level-filter container with two .filter-chip buttons inside #deck-selection"
      contains: "level-filter"
    - path: "src/css/style.css"
      provides: ".level-filter, .filter-chip, .filter-chip.active, .filter-chip:hover, .filter-chip.active:hover styles"
      contains: "filter-chip"
    - path: "src/locales/it/ui.js"
      provides: "filters.levelA1 and filters.levelA2 keys in Italian locale"
      contains: "filters"
    - path: "src/locales/es/ui.js"
      provides: "filters.levelA1 and filters.levelA2 keys in Spanish locale"
      contains: "filters"
    - path: "src/js/core/app.js"
      provides: "renderFilterChips() exported function + chip click handler in setupEventListeners() + renderFilterChips() call in renderDecks()"
      contains: "renderFilterChips"
  key_links:
    - from: "index.html #level-filter"
      to: "src/js/core/app.js setupEventListeners"
      via: "document.getElementById('level-filter').addEventListener('click', ...)"
      pattern: "level-filter.*addEventListener|addEventListener.*level-filter"
    - from: "src/js/core/app.js renderDecks"
      to: "src/js/core/app.js renderFilterChips"
      via: "renderFilterChips() call at top of renderDecks()"
      pattern: "renderFilterChips\\(\\)"
    - from: "index.html .filter-chip"
      to: "src/locales/it/ui.js filters.levelA1"
      via: "data-i18n='filters.levelA1' attribute resolved by initializeI18n()"
      pattern: "data-i18n=\"filters\\.level"
    - from: "src/js/core/app.js chip click handler"
      to: "src/js/core/app.js updateActiveLevels"
      via: "updateActiveLevels(next) call in click handler"
      pattern: "updateActiveLevels\\(next\\)"
---

<objective>
Implement the visible filter chip UI: HTML container + buttons, CSS styles, i18n keys in both locales, and event wiring in app.js. Turn the RED test suite (from Plan 01) GREEN.

Purpose: Completes FLTR-01 and FLTR-09 — users can now see and toggle level filter chips above the deck grid, with labels from the i18n system.
Output: Working chip UI; all 7 filter-ui.test.js tests pass; checkpoint confirms visual and interactive behavior in browser.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-filter-logic/07-03-SUMMARY.md
@.planning/phases/08-filter-ui/08-RESEARCH.md
@.planning/phases/08-filter-ui/08-01-SUMMARY.md
@index.html
@src/css/style.css
@src/locales/it/ui.js
@src/locales/es/ui.js
@src/js/core/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add i18n keys, HTML chip container, and CSS chip styles</name>
  <files>
    src/locales/it/ui.js
    src/locales/es/ui.js
    index.html
    src/css/style.css
  </files>
  <action>
    **1. src/locales/it/ui.js** — Add `filters` namespace inside the exported default object.
    Place it after the last existing top-level key (before the closing `}`). Exact addition:
    ```js
    filters: {
        levelA1: 'A1',
        levelA2: 'A2'
    },
    ```
    Use 'A1' and 'A2' as bare CEFR codes — language-neutral per RESEARCH.md recommendation.

    **2. src/locales/es/ui.js** — Same addition, same position, same values:
    ```js
    filters: {
        levelA1: 'A1',
        levelA2: 'A2'
    },
    ```

    **3. index.html** — Inside `<section id="deck-selection">`, between the
    `<p class="subtitle" data-i18n="deckSelection.subtitle"></p>` line and the
    `<div class="deck-grid" id="deck-grid">` div, insert:
    ```html
    <div class="level-filter" id="level-filter" role="group" aria-label="Filter by level">
        <button class="filter-chip" data-level="A1" data-i18n="filters.levelA1"></button>
        <button class="filter-chip" data-level="A2" data-i18n="filters.levelA2"></button>
    </div>
    ```
    Notes:
    - Use `role="group"` and `aria-label` for accessibility (per RESEARCH.md open question 3 — one-line win)
    - `data-i18n` attributes are picked up automatically by the existing `initializeI18n()` scan
    - Place INSIDE `#deck-selection` so chips are hidden automatically when the flashcard view is shown (avoids RESEARCH.md pitfall 4)
    - Do NOT place chips inside the flashcard view section

    **4. src/css/style.css** — Add chip styles after the language selector styles section.
    Find a suitable comment anchor (e.g., the language button styles) and append:
    ```css
    /* Level Filter Chips */
    .level-filter {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .filter-chip {
        background: var(--color-white);
        border: 2px solid rgba(0, 0, 0, 0.12);
        border-radius: var(--radius-full);
        padding: 0.35rem 1rem;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--color-text-light);
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: var(--font-main);
        box-shadow: var(--shadow-sm);
    }

    .filter-chip:hover {
        border-color: var(--color-teal);
        color: var(--color-text);
    }

    .filter-chip.active {
        background: var(--color-teal);
        border-color: var(--color-teal);
        color: var(--color-white);
        box-shadow: 0 2px 8px rgba(0, 168, 150, 0.35);
    }

    .filter-chip.active:hover {
        background: #009688;
        border-color: #009688;
    }
    ```
    Rationale: Uses existing CSS custom properties (`--color-teal`, `--color-white`,
    `--color-text-light`, `--radius-full`, `--shadow-sm`). Active state with filled
    teal background matches `.language-option.active` pattern. Pills match `.language-btn`
    and `.deck-card-badge` using `--radius-full`.
  </action>
  <verify>
    <automated>bun run test -- tests/filter-ui.test.js 2>&1 | tail -20</automated>
    <manual>After adding i18n keys, the 4 FLTR-09 tests should turn green. HTML and CSS changes have no unit tests but will be verified at the checkpoint.</manual>
    <sampling_rate>Run after completing this task, before starting Task 2</sampling_rate>
  </verify>
  <done>
    `itUI.filters.levelA1` and `itUI.filters.levelA2` resolve to 'A1'/'A2' (4 FLTR-09 tests green).
    index.html has `#level-filter` with two `.filter-chip` buttons inside `#deck-selection`.
    style.css has `.filter-chip` and `.filter-chip.active` rules using CSS custom properties.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire renderFilterChips(), click handler, and export in app.js</name>
  <files>src/js/core/app.js</files>
  <action>
    **Step A — Add `renderFilterChips()` function** (module-level, after `updateActiveLevels`):
    ```js
    export function renderFilterChips() {
        const activeLevels = getActiveLevels();
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.classList.toggle('active', activeLevels.includes(chip.dataset.level));
        });
    }
    ```
    - Must be EXPORTED so tests/filter-ui.test.js can import it directly
    - Reads `getActiveLevels()` fresh on every call — no stale closure

    **Step B — Call `renderFilterChips()` at the top of `renderDecks()`**:
    Find the existing `renderDecks()` function. Add `renderFilterChips();` as the
    first statement inside the function body, before `deckGrid.innerHTML = ''`.
    This ensures chip visual state is always consistent with `activeLevels`
    whenever the deck grid re-renders (covers: initial load, language switch,
    goHome, resetProgress, and chip click). Avoids RESEARCH.md pitfall 2
    (chip state desync after language switch).

    **Step C — Add chip click handler in `setupEventListeners()`**:
    Find the existing `setupEventListeners()` function. Add the following
    event delegation block (attach ONCE — not inside renderDecks, avoids pitfall 3):
    ```js
    document.getElementById('level-filter').addEventListener('click', (e) => {
        const chip = e.target.closest('.filter-chip');
        if (!chip) return;

        const clickedLevel = chip.dataset.level;
        const current = getActiveLevels();
        const next = current.includes(clickedLevel)
            ? current.filter(l => l !== clickedLevel)  // remove (may produce [])
            : [...current, clickedLevel];               // add

        updateActiveLevels(next); // FLTR-06 guard in setActiveLevels handles empty []
        renderDecks();            // re-renders badges AND chips via renderFilterChips()
    });
    ```
    - Uses `chip.dataset.level` (not hardcoded 'A1'/'A2' strings) — avoids pitfall in RESEARCH.md
    - Does NOT call `renderFilterChips()` separately; `renderDecks()` already calls it
    - `updateActiveLevels(next)` is a no-op if `next` is `[]` (FLTR-06 guard in state.js)

    Do NOT re-attach the listener in renderDecks(). Do NOT add a second export for
    updateActiveLevels (it is module-local, chip handler is in the same file).
  </action>
  <verify>
    <automated>bun run test -- tests/filter-ui.test.js 2>&1 | tail -20</automated>
    <manual>All 7 tests (4 FLTR-09 + 3 FLTR-01) should be green.</manual>
    <sampling_rate>Run after this task completes; also run full suite: bun run test</sampling_rate>
  </verify>
  <done>
    `renderFilterChips` is exported from app.js.
    All 7 filter-ui.test.js tests pass.
    Full test suite (`bun run test`) passes with no regressions.
    `renderDecks()` calls `renderFilterChips()` as first statement.
    Chip click handler is wired in `setupEventListeners()` using event delegation on `#level-filter`.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual and interactive verification of chip UI in browser</name>
  <files>N/A — visual verification only</files>
  <action>Run `bun run dev` and verify chip UI behavior in browser per steps in how-to-verify.</action>
  <verify>
    <automated>bun run test 2>&1 | tail -10</automated>
    <manual>Follow the 7-step how-to-verify checklist below in a real browser.</manual>
  </verify>
  <done>All 7 browser verification steps pass; user types "approved".</done>
  <what-built>
    Level filter chips UI:
    - Two pill-shaped buttons (A1, A2) above the deck grid on the deck selection screen
    - Teal filled background on active chips; muted outline on inactive chips
    - Chip click toggles active state and immediately refreshes deck badge counts
    - Cannot deselect both chips simultaneously (FLTR-06 guard via setActiveLevels)
    - Chip labels change when switching language (i18n via data-i18n attribute)
  </what-built>
  <how-to-verify>
    Run `bun run dev` and open http://localhost:5173 in a browser.

    1. Select a language (Italian or Spanish). On the deck selection screen, confirm
       two pill-shaped chip buttons labeled "A1" and "A2" appear above the deck grid.
       Both should appear active (teal filled) since returning users default to A1+A2.

    2. Click the "A2" chip to deactivate it. Confirm:
       a. A2 chip becomes outline-only (inactive style)
       b. Deck badge counts update immediately to show only A1 due cards
       c. A1 chip remains active (teal)

    3. Click "A2" again to reactivate. Confirm both chips are active and badge counts
       show the combined A1+A2 count.

    4. Click "A1" to deactivate it (leaving A2 active). Confirm A2 badge counts.
       Then click "A1" to deactivate the currently-only-active chip: confirm the click
       is silently ignored (A1 stays active, badge counts unchanged — FLTR-06 guard).

    5. Switch language (toggle between Italian/Spanish). Confirm chip labels still read
       "A1" and "A2" (same CEFR codes regardless of language) and active state persists.

    6. Refresh the browser. Confirm the chip active state (A1/A2 selection) is restored
       from localStorage on reload.

    7. Navigate into a deck to study, then return home. Confirm chips are visible and
       retain their state. Confirm chips are NOT visible during the flashcard study view.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
`bun run test` — all tests pass (no regressions).
Visual check via `bun run dev`: chips appear above deck grid, toggle works, badge counts update, language switch preserves labels, localStorage restores selection on refresh.
</verification>

<success_criteria>
1. `bun run test` — all tests green including all 7 in filter-ui.test.js
2. Chip buttons are visible above deck grid in browser
3. Toggling chips updates badge counts immediately
4. Cannot deselect both chips (FLTR-06 guard verified manually)
5. Language switch: chip labels remain "A1"/"A2" from i18n keys
6. Chip active state survives page refresh (localStorage persistence)
7. Chips absent from flashcard view
</success_criteria>

<output>
After completion, create `.planning/phases/08-filter-ui/08-02-SUMMARY.md`
</output>
