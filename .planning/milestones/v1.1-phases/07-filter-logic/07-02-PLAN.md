---
phase: 07-filter-logic
plan: 02
type: tdd
wave: 2
depends_on: [07-01]
files_modified:
  - tests/filter-logic.test.js
autonomous: true
requirements: [FLTR-02, FLTR-03, FLTR-04, FLTR-05, FLTR-06]

must_haves:
  truths:
    - "All filter state and persistence tests pass (bun run test exits 0)"
    - "FLTR-02: setActiveLevels(['A1']) sets state to ['A1']; setActiveLevels(['A1','A2']) sets to both"
    - "FLTR-06: setActiveLevels([]) and setActiveLevels(null) are no-ops — prior state unchanged"
    - "FLTR-05: saveLevelFilter(['A1']) + loadLevelFilter() round-trips to ['A1']"
    - "FLTR-05: loadLevelFilter() returns null when localStorage key is absent"
    - "FLTR-03: hasProgressData() returns false when progress is empty (new user)"
    - "FLTR-04: hasProgressData() returns true when progress has at least one key (returning user)"
  artifacts:
    - path: "tests/filter-logic.test.js"
      provides: "Unit tests for activeLevels state, level-filter localStorage, and user-type detection"
      min_lines: 60
  key_links:
    - from: "tests/filter-logic.test.js"
      to: "src/js/core/state.js"
      via: "direct function import (getActiveLevels, setActiveLevels)"
      pattern: "import.*getActiveLevels.*setActiveLevels"
    - from: "tests/filter-logic.test.js"
      to: "src/js/features/progress.js"
      via: "direct function import (loadLevelFilter, saveLevelFilter, hasProgressData, loadProgress)"
      pattern: "import.*loadLevelFilter"
---

<objective>
Write the TDD test suite for the filter state and persistence functions added in Plan 01. Tests cover FLTR-02, FLTR-05, FLTR-06, FLTR-03, FLTR-04.

Purpose: Verify the foundation functions are correct before app.js wiring (Plan 03) depends on them. TDD RED→GREEN cycle gives confidence that the setActiveLevels guard, null-returning loadLevelFilter, and hasProgressData detection all behave as specified.
Output: tests/filter-logic.test.js with passing tests for all five requirements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/07-filter-logic/07-RESEARCH.md
@src/js/core/state.js
@src/js/features/progress.js
@tests/vitest.setup.js
@tests/progress.test.js
</context>

<feature>
  <name>Filter State and Persistence</name>
  <files>tests/filter-logic.test.js, src/js/core/state.js, src/js/features/progress.js</files>
  <behavior>
Import `getActiveLevels` and `setActiveLevels` from `../src/js/core/state.js`.
Import `loadLevelFilter`, `saveLevelFilter`, `hasProgressData`, `loadProgress` from `../src/js/features/progress.js`.

Note on import constraints: `progress.js` imports from `../core/i18n.js` which reads localStorage for the locale key. The test environment has localStorage mocked (vitest.setup.js). Before importing, mock the locale key: `localStorage.setItem('language-learning-locale', 'it')` in a beforeAll or beforeEach so `getLocale()` returns 'it' and the level-filter key resolves to `it-level-filter`.

**Test cases to write:**

describe('activeLevels state — FLTR-02, FLTR-06'):
- `setActiveLevels(['A1'])` → `getActiveLevels()` returns `['A1']`
- `setActiveLevels(['A1', 'A2'])` → `getActiveLevels()` returns `['A1', 'A2']`
- `setActiveLevels([])` is a no-op: state remains unchanged from prior set
- `setActiveLevels(null)` is a no-op: state remains unchanged from prior set
- `getActiveLevels()` returns a copy: mutating the returned array does not affect internal state (push 'X2' onto returned array, then getActiveLevels() should not contain 'X2')

describe('level-filter localStorage — FLTR-05'):
- `loadLevelFilter()` returns `null` when localStorage has no key
- `saveLevelFilter(['A1'])` then `loadLevelFilter()` returns `['A1']`
- `saveLevelFilter(['A1', 'A2'])` then `loadLevelFilter()` returns `['A1', 'A2']`
- `loadLevelFilter()` returns `null` when stored value is corrupted JSON (localStorage.setItem with invalid JSON, then call)

describe('hasProgressData — FLTR-03, FLTR-04'):
- After `loadProgress()` with empty localStorage, `hasProgressData()` returns `false`
- After calling `loadProgress()` when `it-progress` contains `{"food_0":{"box":1,"nextReview":"2026-01-01"}}`, `hasProgressData()` returns `true`
  </behavior>
  <implementation>
RED: Write all tests first. Run `bun run test tests/filter-logic.test.js` — expect failures for any function not yet added to Plan 01 exports, and passes for those that were. Since Plan 01 should already be executed before this plan runs, expect all RED tests to become GREEN immediately (Plan 01 is done). If tests pass on first run, the RED step is satisfied by the architectural design (Plan 01 written first, tests confirm the contract).

GREEN: All tests pass after Plan 01 is merged. No additional implementation needed.

REFACTOR: Check for any duplication in test setup. Extract `localStorage.setItem('language-learning-locale', 'it')` into a `beforeEach` to keep tests DRY.

Follow the import pattern from `tests/deck-utils.test.js` — import directly from source files. Do not mock the modules; test the real implementations.
  </implementation>
</feature>

<verification>
Run: `bun run test tests/filter-logic.test.js`
All tests must pass. Zero failures.

Run: `bun run test`
All tests must pass — no regressions in existing suites (progress.test.js, deck-utils.test.js, data-integrity.test.js).
</verification>

<success_criteria>
- tests/filter-logic.test.js exists with at least 10 test cases
- All tests pass: activeLevels state (FLTR-02/06), localStorage round-trip (FLTR-05), hasProgressData new/returning user (FLTR-03/04)
- Full test suite (bun run test) exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/07-filter-logic/07-02-SUMMARY.md` following the summary template.
</output>
