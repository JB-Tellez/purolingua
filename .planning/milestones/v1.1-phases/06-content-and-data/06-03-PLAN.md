---
phase: 06-content-and-data
plan: 03
type: tdd
wave: 2
depends_on:
  - "06-01"
  - "06-02"
files_modified:
  - tests/data-integrity.test.js
autonomous: true
requirements:
  - CONT-01
  - CONT-02
  - CONT-03

must_haves:
  truths:
    - "Running `bun run test` passes with the data-integrity test suite included"
    - "The test suite catches any card missing a level field in either language"
    - "The test suite catches any deck with fewer than 4 A1 cards"
    - "The test suite catches any A1 card placed before an A2 card (append-order violation)"
  artifacts:
    - path: "tests/data-integrity.test.js"
      provides: "Vitest data-integrity test for card level fields"
      exports: ["describe Data Integrity — Card Level Fields"]
      min_lines: 40
  key_links:
    - from: "tests/data-integrity.test.js"
      to: "src/locales/it/decks.js"
      via: "ES module import"
      pattern: "import itDecks from '../src/locales/it/decks.js'"
    - from: "tests/data-integrity.test.js"
      to: "src/locales/es/decks.js"
      via: "ES module import"
      pattern: "import esDecks from '../src/locales/es/decks.js'"
---

<objective>
Write a Vitest data-integrity test that imports both locale deck files and asserts every card has a valid `level` field, every deck has at least 4 A1 cards, and A1 cards are appended after A2 cards.

Purpose: Makes the Phase 6 data guarantees machine-verifiable. Protects against regressions when decks are edited in the future. Confirms CONT-01, CONT-02, and CONT-03 are fully satisfied.
Output: `tests/data-integrity.test.js` — a self-contained Vitest test file that passes when both deck files are correctly structured.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-content-and-data/06-RESEARCH.md
@.planning/phases/06-content-and-data/06-01-SUMMARY.md
@.planning/phases/06-content-and-data/06-02-SUMMARY.md
</context>

<feature>
  <name>Data Integrity — Card Level Fields</name>
  <files>tests/data-integrity.test.js, src/locales/it/decks.js, src/locales/es/decks.js</files>
  <behavior>
    The test file asserts five properties across both deck files:

    1. Every Italian card has `level` equal to "A1" or "A2" (no missing, null, or typo values)
    2. Every Spanish card has `level` equal to "A1" or "A2"
    3. Every Italian deck has at least 4 cards with `level === "A1"`
    4. Every Spanish deck has at least 4 cards with `level === "A1"`
    5. In every deck (both languages), no A2 card appears after an A1 card — append order is preserved

    Failure messages must name the deck ID and card index to enable quick debugging.
  </behavior>
  <implementation>
    Create `tests/data-integrity.test.js` using the exact pattern from the research file. The test uses ES module imports (project is `"type": "module"`). Vitest is already configured with `include: ['tests/**/*.test.js']` — no config changes needed.

    Use this implementation exactly as specified in the research (RESEARCH.md "Pattern: Data-Integrity Test"):

    ```js
    import { describe, it, expect } from 'vitest';
    import itDecks from '../src/locales/it/decks.js';
    import esDecks from '../src/locales/es/decks.js';

    const VALID_LEVELS = ['A1', 'A2'];
    const MIN_A1_PER_DECK = 4;

    describe('Data Integrity — Card Level Fields', () => {
        it('every Italian card has a valid level field', () => {
            itDecks.forEach(deck => {
                deck.cards.forEach((card, index) => {
                    expect(
                        VALID_LEVELS.includes(card.level),
                        `Italian deck "${deck.id}" card[${index}] has invalid level: "${card.level}"`
                    ).toBe(true);
                });
            });
        });

        it('every Spanish card has a valid level field', () => {
            esDecks.forEach(deck => {
                deck.cards.forEach((card, index) => {
                    expect(
                        VALID_LEVELS.includes(card.level),
                        `Spanish deck "${deck.id}" card[${index}] has invalid level: "${card.level}"`
                    ).toBe(true);
                });
            });
        });

        it('every Italian deck has at least 4 A1 cards', () => {
            itDecks.forEach(deck => {
                const a1Count = deck.cards.filter(c => c.level === 'A1').length;
                expect(
                    a1Count,
                    `Italian deck "${deck.id}" has only ${a1Count} A1 cards (need >= 4)`
                ).toBeGreaterThanOrEqual(MIN_A1_PER_DECK);
            });
        });

        it('every Spanish deck has at least 4 A1 cards', () => {
            esDecks.forEach(deck => {
                const a1Count = deck.cards.filter(c => c.level === 'A1').length;
                expect(
                    a1Count,
                    `Spanish deck "${deck.id}" has only ${a1Count} A1 cards (need >= 4)`
                ).toBeGreaterThanOrEqual(MIN_A1_PER_DECK);
            });
        });

        it('A1 cards are appended after A2 cards in every deck', () => {
            [...itDecks, ...esDecks].forEach(deck => {
                let seenA1 = false;
                deck.cards.forEach((card, index) => {
                    if (card.level === 'A1') seenA1 = true;
                    if (seenA1 && card.level === 'A2') {
                        throw new Error(
                            `Deck "${deck.id}" card[${index}] is A2 after A1 cards — append order violated`
                        );
                    }
                });
            });
        });
    });
    ```

    Write the file exactly as shown. Then run `bun run test` and confirm the suite passes (5 tests, all green).
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: Write data-integrity test and confirm it passes</name>
  <files>tests/data-integrity.test.js</files>
  <action>
    Create `tests/data-integrity.test.js` with the implementation shown in the `<feature>` section above.

    The test file must:
    - Import from `'vitest'` (not `'@vitest/runner'` — use the standard import)
    - Import `itDecks` from `'../src/locales/it/decks.js'`
    - Import `esDecks` from `'../src/locales/es/decks.js'`
    - Define 5 `it()` blocks in one `describe()` block
    - Use failure messages that name deck.id and card index

    After writing the file, run `bun run test` to confirm the test suite passes. If any test fails, diagnose whether it is a test authoring error or a data error in the deck files. Fix the root cause (data error = fix deck file; test error = fix test).

    Do NOT modify `vitest.config.js` — the glob `tests/**/*.test.js` already picks up this file.
  </action>
  <verify>`bun run test` output shows "5 tests | 5 passed" (or the full test suite count with all passing). The data-integrity suite must show 0 failures.</verify>
  <done>
    - `tests/data-integrity.test.js` exists
    - `bun run test` passes with 0 failures
    - All 5 data-integrity assertions are green:
      1. Every Italian card has a valid level field
      2. Every Spanish card has a valid level field
      3. Every Italian deck has at least 4 A1 cards
      4. Every Spanish deck has at least 4 A1 cards
      5. A1 cards are appended after A2 cards in every deck
  </done>
</task>

</tasks>

<verification>
After the task completes:
1. `bun run test` exits with code 0 (all tests pass)
2. `tests/data-integrity.test.js` exists and is non-empty
3. The test output shows "Data Integrity — Card Level Fields" suite with 5 passing tests
4. No existing tests regressed (progress.test.js, deck-utils.test.js, app.test.js, audio.test.js still pass)
</verification>

<success_criteria>
- `tests/data-integrity.test.js` created with 5 test cases
- `bun run test` passes with all tests green (data-integrity + pre-existing tests)
- Phase 6 data guarantees are machine-verifiable: level fields present, A1 minimum met, append order enforced
</success_criteria>

<output>
After completion, create `.planning/phases/06-content-and-data/06-03-SUMMARY.md`
</output>
